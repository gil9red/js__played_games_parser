<!DOCTYPE html>
<html>
<head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>js__mini_played_games_parser</title>

    <link rel="stylesheet" type="text/css" href="static/bootstrap-4.4.1/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="static/my-bootstrap-treeview-2.1.0/my-bootstrap-treeview.css">
    <link rel="stylesheet" type="text/css" href="static/bootstrap4-toggle-v3.5.0/bootstrap4-toggle.css">
    <link rel="stylesheet" type="text/css" href="static/glyphicon/glyphicon.css">
    <link rel="stylesheet" type="text/css" href="static/jquery.jsonview/jquery.jsonview.css">

    <script src="static/js/jquery-2.1.4.js"></script>
    <script src="static/bootstrap-4.4.1/bootstrap.bundle.js"></script>
    <script src="static/my-bootstrap-treeview-2.1.0/my-bootstrap-treeview.js"></script>
    <script src="static/bootstrap4-toggle-v3.5.0/bootstrap4-toggle.js"></script>
    <script src="static/js/parser.js"></script>
    <script src="static/jquery.jsonview/jquery.jsonview.js"></script>

    <style>
        pre.code-json, textarea {
            overflow: scroll;
            white-space: pre;
            font-family: "Lucida Console", Monaco, monospace;
            font-size: 0.8rem;
            line-height: 1.2;

            width: 100%;
            height: 85vh;
        }

        .platform {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .category {
            font-size: 1.1rem;
        }
        .game {
            font-size: 1rem;
        }

        /* Small devices (Phones, 600pxand down) */
        @media only screen and (max-width: 600px) {
            .platform {
                font-weight: bold;
                font-size: 1rem;
            }
            .category {
                font-size: 1rem;
            }
            .game {
                font-size: 0.9rem;
            }
        }

        .treeview .badge {
            margin-left: 0.4em;
        }

        .noselect {
          -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
             -khtml-user-select: none; /* Konqueror HTML */
               -moz-user-select: none; /* Old versions of Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                    user-select: none; /* Non-prefixed version, currently
                                          supported by Chrome, Opera and Firefox */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col m-2">
                <div class="progress" style="display: none">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                       aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 75%;">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-1">
                <div class="row">
                    <div class="col">
                        <button class="btn btn-primary" onclick="refresh_parse()"><span class="glyphicon glyphicon-refresh"></span></button>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="row">
                    <div class="col text-truncate">
                        <a target="_blank" id="url_gist"></a>
                    </div>
                </div>
            </div>
            <div class="col-1">
                <a href="https://github.com/gil9red/js__played_games_parser">Github</a>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <button id="notify_need_refresh" type="button" class="btn btn-warning m-2 btn-block" onclick="refresh_parse()" style="display: none">
                    Данные не актуальны! Жми, чтобы обновить!
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div id="msg_error" class="alert alert-danger alert-dismissible m-2" style="display: none">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <strong>Error!</strong> <div id="msg_error_text"></div>
                </div>
            </div>
        </div>

        <nav class="mt-2">
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <a class="nav-item nav-link active" id="nav-raw_text-tab" data-toggle="tab" href="#nav-raw_text" role="tab" aria-controls="nav-raw_text" aria-selected="true">RAW text</a>
                <a class="nav-item nav-link" id="nav-as_json-tab" data-toggle="tab" href="#nav-as_json" role="tab" aria-controls="nav-as_json" aria-selected="false">Parsed as JSON</a>
                <a class="nav-item nav-link" id="nav-as_tree-tab" data-toggle="tab" href="#nav-as_tree" role="tab" aria-controls="nav-as_tree" aria-selected="false">Parser as Tree</a>
                <a class="nav-item nav-link" id="nav-as_tree_raw-tab" data-toggle="tab" href="#nav-as_tree_raw" role="tab" aria-controls="nav-as_tree_raw" aria-selected="false">Parser as Tree (RAW)</a>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-raw_text" role="tabpanel" aria-labelledby="nav-raw_text-tab">
                <textarea readonly="readonly" id="result_raw" cols="100" rows="10"></textarea>
            </div>
            <div class="tab-pane fade" id="nav-as_json" role="tabpanel" aria-labelledby="nav-as_json-tab">
                <div class="d-flex">
                    <nav>
                        <div class="nav nav-pills justify-content-end" id="nav-tab_result_json" role="tablist">
                            <a class="nav-item nav-link small text-uppercase active" id="nav-result_json_view-tab" data-toggle="tab" href="#nav-result_json_view" role="tab" aria-controls="nav-result_json_view" aria-selected="true">View</a>
                            <a class="nav-item nav-link small text-uppercase" id="nav-result_json-tab" data-toggle="tab" href="#nav-result_json" role="tab" aria-controls="nav-result_json" aria-selected="false">Raw</a>
                        </div>
                    </nav>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="nav-result_json_view" role="tabpanel" aria-labelledby="nav-result_json_view-tab">
                            <pre id="result_json_view" class="code-json"></pre>
                        </div>
                        <div class="tab-pane fade" id="nav-result_json" role="tabpanel" aria-labelledby="nav-result_json-tab">
                            <pre id="result_json" class="code-json"></pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-as_tree" role="tabpanel" aria-labelledby="nav-as_tree-tab">
                <div class="container-fluid ml-0 mr-0 pl-0 pr-0">
                    <div class="row flex-row-reverse">
                        <div class="col-md-2 w-100">
                            <div class="p-1">
                                <input
                                        id="switch_visible_table_stats"
                                        type="checkbox"
                                        data-toggle="toggle" data-width="100%"
                                        data-on="Statistics Table" data-off="Statistics Table"
                                        data-onstyle="primary" data-offstyle="secondary"
                                >
                            </div>
                            <table id="table_stats" class="table collapse">
                                <tr><td>Игр:</td><td id="stats_total_games">-</td></tr>
                                <tr><td>Платформ:</td><td id="stats_total_platforms">-</td></tr>
                                <tr><td>Обновление вкладок (мс):</td><td id="stats_elapsed_time_update_tabs">-</td></tr>
                                <tr><td>Построение дерева (мс):</td><td id="stats_elapsed_time_building">-</td></tr>
                                <tr><td>Поиск (мс):</td><td id="stats_elapsed_time_search">-</td></tr>
                                <tr style="display: none"><td>Найдено игр:</td><td id="stats_found_game">-</td></tr>
                            </table>
                        </div>
                        <div class="col-md-10">
                            <div class="flex-column">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="tree-search" placeholder="Type to search..." aria-describedby="basic-addon2">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-danger" type="button" onclick="$('#tree-search').val(''); search();">Clear</button>
                                    </div>
                                </div>
                                <div id="tree"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-as_tree_raw" role="tabpanel" aria-labelledby="nav-as_tree_raw-tab">
                <div class="d-flex">
                    <nav>
                        <div class="nav nav-pills" id="nav-tab_tree_raw" role="tablist">
                            <a class="nav-item nav-link small text-uppercase active" id="nav-tree_raw_view-tab" data-toggle="tab" href="#nav-tree_raw_view" role="tab" aria-controls="nav-tree_raw_view" aria-selected="true">View</a>
                            <a class="nav-item nav-link small text-uppercase" id="nav-tree_raw-tab" data-toggle="tab" href="#nav-tree_raw" role="tab" aria-controls="nav-tree_raw" aria-selected="false">Raw</a>
                        </div>
                    </nav>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="nav-tree_raw_view" role="tabpanel" aria-labelledby="nav-tree_raw_view-tab">
                            <pre id="tree_raw_view" class="code-json"></pre>
                        </div>
                        <div class="tab-pane fade" id="nav-tree_raw" role="tabpanel" aria-labelledby="nav-tree_raw-tab">
                            <pre id="tree_raw" class="code-json"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Для обхода: "Запрос из постороннего источника заблокирован: Политика одного источника запрещает чтение удаленного ресурса"
        $.ajaxPrefilter(options => {
            if (options.crossDomain && jQuery.support.cors) {
                var http = (window.location.protocol === 'http:' ? 'http:' : 'https:');
                options.url = http + '//cors-anywhere.herokuapp.com/' + options.url;
                //options.url = "http://cors.corsproxy.io/url=" + options.url;
            }
        });

        function on_change_visible_table_stats(visible) {
            if (visible == null) {
                visible = $("#switch_visible_table_stats").prop('checked');
            }

            localStorage.switch_visible_table_stats = visible;

            let table = $('#table_stats');
            table.toggleClass('show', visible);
        }

        $(document).ready(function () {
            // NOTE: On android Chrome not auto restore checked value after refresh page
            if (localStorage.switch_visible_table_stats != null) {
                let checked = localStorage.switch_visible_table_stats == "true";
                $('#switch_visible_table_stats').bootstrapToggle(checked ? 'on' : 'off');
            }

            on_change_visible_table_stats();

            $('#switch_visible_table_stats').change(function() {
                let visible = $(this).prop('checked');
                on_change_visible_table_stats(visible);
            });
        });

        function show_error(text) {
            $('#msg_error').show();
            $('#msg_error_text').text(text);
        }

        function process_error(jqXHR, textStatus, errorThrown) {
            console.log("error: " + jqXHR + ", " + textStatus + ", " + errorThrown);
            $('#result_raw').text("<error>");
            show_error(jqXHR + ", " + textStatus + ", " + errorThrown);

            setProgress(0);
        }

        function refresh_parse() {
            $('#notify_need_refresh').hide();

            setProgress(1);

            $.get(url_gist, response => {
                setProgress(25);

                let text = parse_gist_file(response);
                if (text != null) {
                    console.log("Success parse gist content from " + url_gist);
                    process_text_file_gist(text);
                }

            }).fail(process_error);
        }

        function check_actuality_of_cache() {
            console.log("Check actuality of cache");

            // Если кэша нет
            if (localStorage.cache_text_file_gist == null) {
                $('#notify_need_refresh').show();
                return;
            }

            $.get(url_gist, response => {
                let is_actual_cache = parse_gist_file(response) == localStorage.cache_text_file_gist;

                // Если кэш актуален
                if (is_actual_cache) {
                    console.log("Cache is actual!");
                    $('#notify_need_refresh').hide();

                } else {
                    console.log("Cache is not actual!");
                    $('#notify_need_refresh').show();
                }
            });
        }

        function onChangeNodeExpanded(event, node) {
            // Обработка событий, инициированных действиями пользователя
            if (!event.is_user_click) {
                return;
            }

            let nodeExpandedStates = null;
            if (localStorage.nodeExpandedStates == null) {
                nodeExpandedStates = new Map();
            } else {
                nodeExpandedStates = new Map(JSON.parse(localStorage.nodeExpandedStates));
            }

            nodeExpandedStates.set(node.nodeId, node.state.expanded);

            localStorage.nodeExpandedStates = JSON.stringify(
                Array.from(nodeExpandedStates.entries())
            );
        }

        function restoreNodesState() {
            if (localStorage.nodeExpandedStates == null) {
                return;
            }

            let tree = $('#tree');
            let startTime = new Date();

            let nodeExpandedStates = new Map(JSON.parse(localStorage.nodeExpandedStates));
            for (let [nodeId, expanded] of nodeExpandedStates.entries()) {
                let node = tree.treeview("getNode", [ nodeId ]);

                if (expanded) {
                    tree.treeview("expandNode", [ node ]);
                } else {
                    tree.treeview("collapseNode", [ node ]);
                }
            }

            var timeDiff = new Date() - startTime; // ms
            console.log(`Elapsed time restore nodes state: ${timeDiff} ms`);
        }

        function update_tabs(result_raw, result_json, tree_raw, tree_data) {
            let startTime = new Date();

            $('#result_raw').text(result_raw);

            $('#result_json').text(result_json);
            $('#result_json_view').JSONView(result_json);

            $('#tree_raw').text(tree_raw);
            $('#tree_raw_view').JSONView(tree_raw);

            $('#tree').treeview({
                data: tree_data,
                expandIcon: 'glyphicon glyphicon-chevron-right',
                collapseIcon: 'glyphicon glyphicon-chevron-down',
                showTags: true,
                levels: 3,
                multiSelect: true,
                highlightSelected: false,

                // Events
                onNodeCollapsed: onChangeNodeExpanded,
                onNodeExpanded: onChangeNodeExpanded,
                onLoading: function(e) {
                    this.__startTime = new Date();
                },
                onRendered: function(event, nodes) {
                    var timeDiff = new Date() - this.__startTime; // ms
                    console.log(`Elapsed time building: ${timeDiff} ms`);
                    $('#stats_elapsed_time_building').text(timeDiff);

                    // NOTE: Fix error "Not initialized, can not call method : search"
                    setTimeout(search, 50);

                    // Added tooltips on long-press
                    // TODO: Bugfix "Not initialized, can not call method : getNodes"
                    setTimeout(() => {
                        let nodes = $('#tree').treeview("getNodes");
                        $.each(nodes, function(index, node) {
                            node.$el
                                .attr('data-toggle', 'tooltip')
                                .attr('data-original-title', node.text)
                                .tooltip({trigger: 'manual'});

                            var longPressTimer = null;

                            node.$el.on('mousedown touchstart', function(event) {
                                longPressTimer = setTimeout(() => {
                                    // Show tooltip
                                    node.$el.tooltip('show');
                                    setTimeout(() => node.$el.tooltip('hide'), 1000);

                                }, 2000);

                            }).on('mouseup mouseleave touchend', function() {
                                clearTimeout(longPressTimer);
                            });
                        });
                    }, 50);
                },
                onSearchComplete: function(event, results) {
                    let number = 0;

                    $("#tree .node-tree.game").each( function(index) {
                        let nodeEl = $(this);
                        let nodeId = nodeEl.attr('data-nodeid');
                        let node = $('#tree').treeview("getNode", [ nodeId ]);
                        $('#tree').treeview("setVisible", [ node, node.searchResult ]);

                        if (node.searchResult) {
                            number++;
                        }
                    });

                    updateGamesNumbers();

                    var timeDiff = new Date() - window.__startTimeSearch; // ms
                    console.log(`Elapsed time search: ${timeDiff} ms [onSearchComplete]`);
                    $('#stats_elapsed_time_search').text(timeDiff);

                    let stats_found_game = $('#stats_found_game');
                    stats_found_game.parent().show();
                    stats_found_game.text(number);

                    restoreNodesState();
                },
                onSearchCleared: function(event, results) {
                    $("#tree .node-tree.node-hidden").each( function(index) {
                        let nodeEl = $(this);
                        let nodeId = nodeEl.attr('data-nodeid');
                        let node = $('#tree').treeview("getNode", [ nodeId ]);
                        $('#tree').treeview("setVisible", [ node, true ]);
                    });

                    updateGamesNumbers();

                    restoreNodesState();

                    var timeDiff = new Date() - window.__startTimeSearch; // ms
                    console.log(`Elapsed time search: ${timeDiff} ms [onSearchCleared]`);
                    $('#stats_elapsed_time_search').text("-");

                    let stats_found_game = $('#stats_found_game');
                    stats_found_game.parent().hide();
                },
            });
            $('#tree').on("click", function(event) {
                let nodeEl = $(event.target);
                let nodeId = nodeEl.attr('data-nodeid');
                let node = $('#tree').treeview("getNode", [ nodeId ]);

                if (node.nodes == undefined) {
                    // ignore
                    return;
                }
                $('#tree').treeview('toggleNodeExpanded', [ node, {is_user_click: true} ]);
            });

            setProgress(100);

            let platforms = JSON.parse(result_json);
            updateStatistics(platforms);

            var timeDiff = new Date() - startTime; // ms
            console.log(`Elapsed time update_tabs: ${timeDiff} ms`);
            $('#stats_elapsed_time_update_tabs').text(timeDiff);
        }

        function process_text_file_gist(text) {
            setProgress(50);

            localStorage.cache_text_file_gist = text;

            let platforms = parse_played_games(text);
            let result_json = stringifyMap(platforms);
            localStorage.cache_result_json = result_json;
            setProgress(75);

            let tree_data = getJsonForTreeView(platforms);
            let tree_raw = JSON.stringify(tree_data, null, 4);
            localStorage.cache_tree_raw = tree_raw;
            setProgress(90);

            update_tabs(
                text,
                result_json,
                tree_raw,
                tree_data
            );
        }

        function setProgress(value) {
            let progressBar = $("#progressBar");

            if (value > 100) {
                value = 100;
            }
            if (value < 0) {
                value = 0;
            }

            progressBar
                .css({"width": value + "%"})
                .attr("aria-valuenow", value);

            progressBar.parent().toggle(
                !(value == 100 || value == 0)
            );
        }

        function search(e) {
            window.__startTimeSearch = new Date();

            let tree = $('#tree');
            let text = $('#tree-search').val();
            console.log(`Call search "${text}"`);

            if (text.length == 0) {
                tree.treeview('clearSearch');
                return;
            }

            tree.treeview("collapseAll", [ {silent: true} ]);

            tree.treeview('search', [ text, {
                ignoreCase: true,    // Case insensitive
                exactMatch: false,   // Like or equals
                revealResults: true, // Reveal matching nodes
                onMatched: function(node, match) {
                    // Only games
                    if (node.level != 3) {
                        return false;
                    }

                    return match;
                }
            }]);
        }

        function updateStatistics(platforms) {
            let total_games = 0;
            let total_platforms = 0;

            for (let [platform_name, categories] of Object.entries(platforms)) {
                total_platforms++;

                for (let [category_name, games] of Object.entries(categories)) {
                    total_games += games.length;
                }
            }

            $('#stats_total_games').text(total_games);
            $('#stats_total_platforms').text(total_platforms);
        }

        function updateGamesNumbers() {
            let categoryId_by_nums = new Map();
            $("#tree .node-tree.game").not('.node-hidden').each( function(index) {
                let nodeEl = $(this);
                let nodeId = nodeEl.attr('data-nodeid');
                let node = $('#tree').treeview("getNode", [nodeId]);

                categoryId_by_nums.set(
                    node.parentId,
                    (categoryId_by_nums.get(node.parentId) || 0) + 1
                );
            });

            let platformId_by_nums = new Map();
            $("#tree .node-tree.category").each( function(index) {
                let nodeEl = $(this);
                let nodeId = nodeEl.attr('data-nodeid');
                let node = $('#tree').treeview("getNode", [ nodeId ]);
                let nums = categoryId_by_nums.get(nodeId) || 0;

                platformId_by_nums.set(
                    node.parentId,
                    (platformId_by_nums.get(node.parentId) || 0) + nums
                );

                let newNode = {
                    tags: [`${nums}`],
                    state: {
                        visible: true,
                        expanded: nums != 0,
                    }
                };
                $('#tree').treeview("updateNode", [ node, newNode, {no_render_all: true} ]);
            });

            for ([platformId, nums] of platformId_by_nums.entries()) {
                let node = $('#tree').treeview("getNode", [ platformId ]);
                let newNode = {
                    tags: [`${nums}`],
                    state: Object.assign({}, node.state),
                };
                newNode.state.expanded = nums != 0;
                $('#tree').treeview("updateNode", [ node, newNode, {no_render_all: true} ]);

                // TODO: Dirty hack
                node.state.expanded = !node.state.expanded;
                $('#tree').treeview("toggleNodeExpanded", [ [node] ]);
            }
        }

        $(document).ready(function() {
            var typingTimer = null;       // Timer identifier
            var doneTypingInterval = 300; // Time in ms

            $('#tree-search').on('input', function() {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(search, doneTypingInterval);
            });

            $("body").on("keyup paste", function(event) {
                // If active tab is "Parser as Tree" or input to #tree-search
                if ($('#nav-as_tree-tab.active').length == 0
                    || event.target.id == 'tree-search') {
                    return;
                }

                let search = $('#tree-search');
                search.focus();

                if (event.type == "keyup" && event.key.length == 1) {
                    search.val(search.val() + event.key).trigger("input");

                } else if (event.type == "paste") {
                    let text = event.originalEvent.clipboardData.getData('text');
                    search.val(search.val() + text).trigger("input");
                }
            })

            // SOURCE: https://stackoverflow.com/a/21494906/5909792
            // SOURCE: https://stackoverflow.com/a/50423867/5909792
            //
            // Значение href вкладки в URI является приоритетным. Если оно не задано, то берем из localStorage
            if (location.hash) {
                $("a[href='" + location.hash + "']").tab("show");
            } else {
                var activeTab = localStorage.getItem('activeTab');
                if (activeTab) {
                    $('#nav-tab a[href="' + activeTab + '"]').tab('show');
                }
            }

            $(window).on("popstate", function() {
                var anchor = location.hash || $("a[data-toggle='tab']").first().attr("href");
                $("a[href='" + anchor + "']").tab("show");
            });

            $('#nav-tab > a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
                let tab_href = $(e.target).attr('href');
                localStorage.setItem('activeTab', tab_href);

                if (history.pushState) {
                    history.pushState(null, null, tab_href);
                } else {
                    location.hash = tab_href;
                }
            });
        });

        const url_gist = "https://gist.github.com/gil9red/2f80a34fb601cd685353";
        $('#url_gist').attr('href', url_gist).text(url_gist);

        $(document).ready(function() {
            // Попробуем при загрузке страницы вытащить данные из кэша
            if (localStorage.cache_text_file_gist != null) {
                console.log("Build from cache");

                update_tabs(
                    localStorage.cache_text_file_gist,
                    localStorage.cache_result_json,
                    localStorage.cache_tree_raw,
                    JSON.parse(localStorage.cache_tree_raw)
                );

                // Проверяем актуальность кэша
                check_actuality_of_cache();

            } else {
                console.log("Build from url");
                refresh_parse();
            }

            // Проверяем актуальность кэша каждые 15 минут
            setInterval(check_actuality_of_cache, 1000 * 60 * 15);
        });
    </script>

</body>
</html>